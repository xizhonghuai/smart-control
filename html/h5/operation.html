<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>设备状态信息</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <meta name="wechat-enable-text-zoom-em" content="true">
    <!--ui-->
    <link rel="stylesheet" href="weui-2.5.9/dist/style/weui.css"/>
    <link rel="stylesheet" href="weui-2.5.9/dist/example/example.css"/>
    <style>
        .page.navbar .weui-tab__panel, .page.tabbar .weui-tab__panel {
            padding: 0px;
        }

        .weui-navbar__item {
            background-color: #b2b2b1;
            color: #d5d4d4;
        }

        .weui-bar__item_on {
            background-color: #ffffff;
            color: #4cce07;
        }

        .weui-panel {
            background-color: rgba(237, 237, 237, 0);
        }

        .my-center {
            position: relative;
            text-align: center;
            padding: 10px 0
        }
    </style>

</head>
<body>
<div class="container" id="container">
    <div class="page navbar js_show" tabindex="-1">
        <div class="page__bd" style="height: 100%;">
            <!--状态数据-->
            <div class=" form_">
                <div class="weui-panel">
                    <div class="weui-panel__hd">
                        <div class="weui-flex">
                            <div>
                                <div class="placeholder" id="device_name_id" style="padding:10px 0">test(1001)
                                </div>
                            </div>
                            <div class="weui-flex__item">
                                <div class="placeholder"></div>
                            </div>
                            <div>
                                <div class="placeholder">
                                            <span>
                                                <a id="power" href="javascript:" role="button" title="等待中"
                                                   onclick="power()"
                                                   class="weui-btn weui-btn_mini weui-btn_primary weui-wa-hotarea weui-btn_loading">
                                                <span class=""></span><span></span>
                                            </a>
                                                &nbsp;  &nbsp;  &nbsp;
                                               <a href="javascript:" role="button" onclick="openPlan()"
                                                  class="weui-btn weui-btn_mini weui-btn_primary weui-wa-hotarea">计划</a>
                                            </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="weui-panel__bd">
                        <div class="weui-media-box weui-media-box_text">
                            <div class="weui-flex js_category">
                                <span class="weui-flex__item">水位:</span>
                                <span id="waterLevel"></span>
                            </div>
                            <div class="weui-flex js_category">
                                <span class="weui-flex__item">剩余药量:</span>
                                <span id="dragAmount"></span>
                            </div>
                            <div class="weui-flex js_category">
                                <span class="weui-flex__item">累积消耗药量:</span>
                                <span id="totalDragAmount"></span>
                            </div>
                            <div class="weui-flex js_category">
                                <span class="weui-flex__item">信号强度:</span>
                                <span id="csq"></span>
                            </div>
                            <div class="weui-flex js_category">
                                <span class="weui-flex__item">累计时长:</span>
                                <span id="runningTime"></span>
                            </div>
                            <div class="weui-flex js_category">
                                <span class="weui-flex__item">设备状态:</span>
                                <span id="state"></span>
                            </div>
                        </div>
                    </div>


                    <div class="weui-panel__bd">
                        <div class="weui-media-box weui-media-box_text">
                            <ul class="weui-media-box__info" aria-hidden="true">
                                <li class="weui-media-box__info__meta" aria-hidden="true" id="js_p4m1_time">
                                    设备时钟:<span id="deviceSystemClock">2022-09-22 12:36:00</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!--tips-->
<div role="alert" id="infoToastPower" style="display: none;">
    <div class="weui-mask_transparent"></div>
    <div class="weui-toast">
        <i class="weui-icon-waiting weui-icon_toast"></i>
        <p class="weui-toast__content" id="toastContent">执行中...</p>
    </div>
</div>

<div role="alert" id="errorToastPower" style="display: none;">
    <div class="weui-mask_transparent"></div>
    <div class="weui-toast">
        <i class="weui-icon-warn weui-icon_toast"></i>

        <p class="weui-toast__content">执行失败</p>
    </div>
</div>


<!--js-->
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js"></script>
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script src="https://res.wx.qq.com/t/wx_fed/cdn_libs/res/weui/1.2.8/weui.min.js"></script>
<script src="weui-2.5.9/dist/example/wah.js"></script>
<script src="weui-2.5.9/utlis.js"></script>
<script>
    var deviceId = getSearchString('deviceId');
    var deviceName = getSearchString('deviceName');
    verifyJump("operation.html?deviceId=" + deviceId);

    function getDevice() {
        let result = httpGet("api/v1/device/by-device-id?deviceId=" + deviceId);
        if (result.code === RES_OK && 'data' in result) {
            let deviceName = result.data.name;
            document.getElementById("device_name_id").innerText = "{0}({1})".format(deviceName, deviceId);
        }
    }

    function getDeviceStatus() {
        let result = httpGet("api/v1/control/device-data?deviceId=" + deviceId);
        if (result.code === RES_OK && 'data' in result) {
            let params = result.data.params;
            document.getElementById('waterLevel').innerText = params.water_level === 1 ? '正常' : '缺水';
            document.getElementById('dragAmount').innerText = params.drag_amount;
            document.getElementById('totalDragAmount').innerText = params.total_drag_amount + "mL";
            document.getElementById('state').innerText = params.state;
            if (params.state === 'running') {
                document.getElementById('power').innerHTML = "<span></span><span>关闭</span>";
                power_value = false;
            } else {
                document.getElementById('power').innerHTML = "<span></span><span>启动</span>";
                power_value = true;
            }
            document.getElementById('csq').innerText = params.csq;
            document.getElementById('runningTime').innerText = params.total_work_time + 'S';
            document.getElementById('deviceSystemClock').innerText = formatDate(new Date(), 'yyyy-MM-dd HH:mm:ss');

        }
    }

    var power_value = true;

    function changePowerText() {
        let html = " <span></span><span>{text}</span>";
        let element = document.getElementById('power');
        if (power_value) {
            element.innerHTML = html.format({
                text: '关闭'
            });
            document.getElementById('state').innerText = 'running';
            power_value = false;
            return;
        }
        element.innerHTML = html.format({
            text: '启动'
        });
        document.getElementById('state').innerText = 'stop';
        power_value = true;
    }

    function power() {
        openToast('infoToastPower');
        let params = {
            deviceId: deviceId,
            power: power_value
        };
        setTimeout(function () {
            let request = httpRequest("api/v1/control/power/sync", 'POST', params);
            closeToast('infoToastPower');
            let susses_flag = false;
            if (request.code === RES_OK && 'data' in request) {
                if (request.data.result === 0) {
                    susses_flag = true;
                }
            }
            console.log(power_value);
            if (susses_flag) {
                setSessionStorage("sate_flag", 1);
            } else {
                toast('errorToastPower');
            }
            changePowerText();
        }, 500);
    }

    function openPlan() {
        window.location.href = 'plan_list.html?deviceId=' + deviceId;
    }

    $(function () {
        getDeviceStatus();
        getDevice();
        setInterval("getDeviceStatus()", 10000);
    });
</script>

</body>
</html>